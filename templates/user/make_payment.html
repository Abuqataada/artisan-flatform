{% extends "base.html" %}

{% block title %}Make Payment - Uwaila Global{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-credit-card me-2"></i>Make Payment</h4>
                </div>
                <div class="card-body">
                    <!-- Service Request Info -->
                    <div class="alert alert-info mb-4">
                        <h5><i class="fas fa-clipboard-list me-2"></i>Service Request Details</h5>
                        <p class="mb-1"><strong>Service:</strong> {{ request.title }}</p>
                        <p class="mb-1"><strong>Description:</strong> {{ request.description[:100] }}...</p>
                        <p class="mb-0"><strong>Amount Due:</strong> {{ form.amount.data|float|format_currency }}</p>
                    </div>
                    
                    <!-- ALWAYS SHOW COMPANY BANK DETAILS FOR BANK TRANSFER -->
                    <div class="alert alert-success mb-4" id="company-bank-details">
                        <h5><i class="fas fa-university me-2"></i>Company Bank Details</h5>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="text-muted small">Account Name</label>
                                    <div class="d-flex justify-content-between align-items-center bg-white p-3 rounded border">
                                        <strong id="accountName">{{ company_details.account_name }}</strong>
                                        <button type="button" class="btn btn-sm btn-outline-primary copy-btn" data-text="{{ company_details.account_name }}">
                                            <i class="fas fa-copy me-1"></i>Copy
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="text-muted small">Account Number</label>
                                    <div class="d-flex justify-content-between align-items-center bg-white p-3 rounded border">
                                        <strong id="accountNumber">{{ company_details.account_number }}</strong>
                                        <button type="button" class="btn btn-sm btn-outline-primary copy-btn" data-text="{{ company_details.account_number }}">
                                            <i class="fas fa-copy me-1"></i>Copy
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="text-muted small">Bank Name</label>
                                    <div class="d-flex justify-content-between align-items-center bg-white p-3 rounded border">
                                        <strong id="bankName">{{ company_details.bank_name }}</strong>
                                        <button type="button" class="btn btn-sm btn-outline-primary copy-btn" data-text="{{ company_details.bank_name }}">
                                            <i class="fas fa-copy me-1"></i>Copy
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="text-muted small">Payment Reference</label>
                                    <div class="d-flex justify-content-between align-items-center bg-white p-3 rounded border">
                                        <strong id="paymentReference">REQ-{{ request.id[:8]|upper }}</strong>
                                        <button type="button" class="btn btn-sm btn-outline-primary copy-btn" data-text="REQ-{{ request.id[:8]|upper }}">
                                            <i class="fas fa-copy me-1"></i>Copy
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-warning mt-3">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Important Instructions</h6>
                            <ul class="mb-0">
                                <li>Transfer the exact amount: <strong>{{ form.amount.data|float|format_currency }}</strong></li>
                                <li>Use <strong>REQ-{{ request.id[:8]|upper }}</strong> as payment reference</li>
                                <li>Upload payment receipt after transfer for verification</li>
                                <li>Payment verification takes 24-48 hours</li>
                            </ul>
                        </div>
                    </div>
                    
                    <form method="POST" action="{{ url_for('user_bp.make_payment', request_id=request.id) }}" enctype="multipart/form-data" id="paymentForm">
                        {{ form.hidden_tag() }}
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.payment_method.label(class="form-label fw-bold") }}
                                    {{ form.payment_method(class="form-select") }}
                                    {% for error in form.payment_method.errors %}
                                        <span class="text-danger">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.amount.label(class="form-label fw-bold") }}
                                    <div class="input-group">
                                        <span class="input-group-text">₦</span>
                                        {{ form.amount(class="form-control", readonly=True) }}
                                    </div>
                                    {% for error in form.amount.errors %}
                                        <span class="text-danger">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Payment Method Specific Fields -->
                        <div id="bank-transfer-fields" class="payment-method-fields mb-4">
                            <h5 class="mb-3">Your Account Details (For Reference)</h5>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {{ form.payer_account_name.label(class="form-label") }}
                                        {{ form.payer_account_name(class="form-control", placeholder="Your account name as it appears on bank statement") }}
                                        {% for error in form.payer_account_name.errors %}
                                            <span class="text-danger">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {{ form.payer_account_number.label(class="form-label") }}
                                        {{ form.payer_account_number(class="form-control", placeholder="10-digit account number") }}
                                        {% for error in form.payer_account_number.errors %}
                                            <span class="text-danger">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {{ form.payer_bank_name.label(class="form-label") }}
                                        {{ form.payer_bank_name(class="form-control", placeholder="Your bank name") }}
                                        {% for error in form.payer_bank_name.errors %}
                                            <span class="text-danger">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {{ form.transaction_reference.label(class="form-label") }}
                                        {{ form.transaction_reference(class="form-control", placeholder="e.g., TRF20240115 or leave blank for auto-generate") }}
                                        {% for error in form.transaction_reference.errors %}
                                            <span class="text-danger">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-group">
                                    {{ form.receipt_image.label(class="form-label") }}
                                    {{ form.receipt_image(class="form-control") }}
                                    <small class="text-muted">
                                        Upload a clear photo or scan of your bank transfer receipt (JPG, PNG, PDF) - 
                                        <span class="text-info">Optional, but recommended for faster verification</span>
                                    </small>
                                    {% for error in form.receipt_image.errors %}
                                        <span class="text-danger">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <div id="cash-fields" class="payment-method-fields mb-4" style="display: none;">
                            <div class="alert alert-warning">
                                <h5><i class="fas fa-money-bill-wave me-2"></i>Cash Payment Instructions</h5>
                                <p class="mb-0">
                                    Pay cash directly to the artisan when they arrive for the service. 
                                    The artisan will confirm receipt and update the payment status.
                                </p>
                            </div>
                        </div>
                        
                        <div id="paystack-fields" class="payment-method-fields mb-4" style="display: none;">
                            <div class="alert alert-info">
                                <h5><i class="fas fa-credit-card me-2"></i>Paystack Payment</h5>
                                <p class="mb-0">
                                    Online payment integration is coming soon! Please use Bank Transfer or Cash payment for now.
                                </p>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="form-group">
                                {{ form.payment_notes.label(class="form-label") }}
                                {{ form.payment_notes(class="form-control", rows=3, placeholder="Any additional payment information...") }}
                                {% for error in form.payment_notes.errors %}
                                    <span class="text-danger">{{ error }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Payment Confirmation -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="confirmPayment" required>
                                    <label class="form-check-label" for="confirmPayment">
                                        I confirm that I have transferred <strong>{{ form.amount.data|float|format_currency }}</strong> to 
                                        <strong>{{ company_details.account_name }}</strong> ({{ company_details.account_number }}) at 
                                        <strong>{{ company_details.bank_name }}</strong> using <strong>REQ-{{ request.id[:8]|upper }}</strong> as reference.
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('user_bp.view_request', request_id=request.id) }}" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-arrow-left me-1"></i> Back
                            </a>
                            {{ form.submit(class="btn btn-primary", id="submitBtn") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Payment Steps Card -->
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-list-ol me-2"></i>Payment Steps</h5>
                </div>
                <div class="card-body">
                    <div class="steps">
                        <div class="step active">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h6>Copy Bank Details</h6>
                                <p class="small mb-0">Copy our account details above</p>
                            </div>
                        </div>
                        <div class="step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h6>Make Transfer</h6>
                                <p class="small mb-0">Transfer exact amount from your bank</p>
                            </div>
                        </div>
                        <div class="step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h6>Submit Details</h6>
                                <p class="small mb-0">Fill and submit this form</p>
                            </div>
                        </div>
                        <div class="step">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <h6>Verification</h6>
                                <p class="small mb-0">We verify within 24-48 hours</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Payment Summary -->
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Payment Summary</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Service Fee:</span>
                        <span class="fw-bold">{{ form.amount.data|float|format_currency }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Processing Fee:</span>
                        <span class="fw-bold">₦0.00</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-3">
                        <span class="fw-bold">Total Amount:</span>
                        <span class="fw-bold fs-5 text-primary">{{ form.amount.data|float|format_currency }}</span>
                    </div>
                    
                    <div class="alert alert-success small">
                        <i class="fas fa-shield-alt me-1"></i>
                        <strong>Secure Payment:</strong> All transactions are secured and encrypted.
                    </div>
                </div>
            </div>
            
            <!-- Bank Transfer Tips -->
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Bank Transfer Tips</h5>
                </div>
                <div class="card-body">
                    <ul class="small mb-0">
                        <li class="mb-2">Use internet/mobile banking or visit your bank branch</li>
                        <li class="mb-2">Double-check account details before transferring</li>
                        <li class="mb-2">Save your transaction receipt/screenshot</li>
                        <li class="mb-2">Use the exact reference for easy tracking</li>
                        <li>Contact support if you need assistance</li>
                    </ul>
                </div>
            </div>
            
            <!-- Help Card -->
            <div class="card shadow">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-question-circle me-2"></i>Need Help?</h5>
                </div>
                <div class="card-body">
                    <p class="small mb-2"><i class="fas fa-phone me-2"></i> <strong>Customer Support:</strong> 0800-UWAILA</p>
                    <p class="small mb-2"><i class="fas fa-envelope me-2"></i> <strong>Email:</strong> payments@uwaila.com</p>
                    <p class="small mb-0"><i class="fas fa-clock me-2"></i> <strong>Hours:</strong> Mon-Fri, 9AM-6PM</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .copy-btn {
        transition: all 0.3s;
    }
    
    .copy-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .copy-btn.copied {
        background-color: #198754;
        color: white;
        border-color: #198754;
    }
    
    .steps {
        position: relative;
        padding-left: 30px;
    }
    
    .steps::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #dee2e6;
    }
    
    .step {
        position: relative;
        margin-bottom: 25px;
    }
    
    .step:last-child {
        margin-bottom: 0;
    }
    
    .step.active .step-number {
        background: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }
    
    .step-number {
        position: absolute;
        left: -30px;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: white;
        border: 2px solid #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #6c757d;
    }
    
    .step-content {
        padding-left: 20px;
    }
    
    .bank-detail-box {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .bank-detail-box label {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 5px;
        display: block;
    }
    
    .bank-detail-box strong {
        font-size: 1.1rem;
        word-break: break-all;
    }
    
    @media (max-width: 768px) {
        .steps {
            padding-left: 25px;
        }
        
        .step-number {
            left: -25px;
            width: 25px;
            height: 25px;
            font-size: 0.9rem;
        }
        
        .bank-detail-box {
            padding: 10px;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy to clipboard functionality
        const copyButtons = document.querySelectorAll('.copy-btn');
        copyButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const text = this.getAttribute('data-text');
                
                navigator.clipboard.writeText(text).then(() => {
                    // Show success feedback
                    const originalHTML = this.innerHTML;
                    this.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
                    this.classList.add('copied');
                    
                    // Revert after 2 seconds
                    setTimeout(() => {
                        this.innerHTML = originalHTML;
                        this.classList.remove('copied');
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    alert('Failed to copy to clipboard. Please select and copy manually.');
                });
            });
        });
        
        // Payment method selection
        const paymentMethodSelect = document.getElementById('payment_method');
        const allMethodFields = document.querySelectorAll('.payment-method-fields');
        const amountInput = document.getElementById('amount');
        const form = document.getElementById('paymentForm');
        const confirmCheckbox = document.getElementById('confirmPayment');
        const submitBtn = document.getElementById('submitBtn');
        
        function showPaymentMethodFields() {
            // Hide all initially
            allMethodFields.forEach(field => {
                field.style.display = 'none';
            });
            
            // Hide company bank details initially too
            const companyBankBox = document.getElementById('company-bank-details');
            if (companyBankBox) companyBankBox.style.display = 'none';
            
            const selectedMethod = paymentMethodSelect.value;

            // 1. Hide all dynamic fields first
            allMethodFields.forEach(field => {
                field.style.display = 'none';
            });

            // 2. Logic for Bank Transfer
            if (selectedMethod === 'bank_transfer') {
                // Show the Company Account Details alert
                if (companyBankBox) companyBankBox.style.display = 'block';
                
                // Show the Payer Input fields (Account Name, Number, etc.)
                document.getElementById('bank-transfer-fields').style.display = 'block';
                
                // Make inputs required
                document.getElementById('payer_account_name').required = true;
                document.getElementById('payer_account_number').required = true;
                document.getElementById('payer_bank_name').required = true;
                
                if (submitBtn) submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i> Submit Payment Details';
            } 
            // 3. Logic for other methods
            else {
                // Hide Company Bank Details if not doing a transfer
                if (companyBankBox) companyBankBox.style.display = 'none';
                
                document.getElementById('payer_account_name').required = false;
                document.getElementById('payer_account_number').required = false;
                document.getElementById('payer_bank_name').required = false;

                if (selectedMethod === 'cash') {
                    document.getElementById('cash-fields').style.display = 'block';
                    if (submitBtn) submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i> Confirm Cash Payment';
                } else if (selectedMethod === 'paystack') {
                    document.getElementById('paystack-fields').style.display = 'block';
                    if (submitBtn) submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i> Proceed to Paystack';
                }
            }
        }
        





        paymentMethodSelect.addEventListener('change', showPaymentMethodFields);
        showPaymentMethodFields(); // Initial display
        
        // Format currency input
        if (amountInput) {
            amountInput.addEventListener('blur', function() {
                const value = parseFloat(this.value);
                if (!isNaN(value)) {
                    this.value = value.toFixed(2);
                }
            });
        }
        
        // Form validation
        if (form) {
            form.addEventListener('submit', function(e) {
                const paymentMethod = paymentMethodSelect.value;
                const amount = parseFloat(amountInput.value);
                
                // Validate amount
                if (isNaN(amount) || amount <= 0) {
                    e.preventDefault();
                    alert('Please enter a valid amount greater than 0');
                    amountInput.focus();
                    return false;
                }
                
                // Validate bank transfer details
                if (paymentMethod === 'bank_transfer') {
                    const accountName = document.getElementById('payer_account_name').value.trim();
                    const accountNumber = document.getElementById('payer_account_number').value.trim();
                    const bankName = document.getElementById('payer_bank_name').value.trim();
                    
                    if (!accountName || !accountNumber || !bankName) {
                        e.preventDefault();
                        alert('Please fill in all bank account details for bank transfer payment');
                        return false;
                    }
                    
                    // Validate account number (10 digits)
                    if (!/^\d{10}$/.test(accountNumber)) {
                        e.preventDefault();
                        alert('Account number must be 10 digits');
                        document.getElementById('payer_account_number').focus();
                        return false;
                    }
                }
                
                // Check confirmation checkbox
                if (confirmCheckbox && confirmCheckbox.required && !confirmCheckbox.checked) {
                    e.preventDefault();
                    alert('Please confirm the payment details by checking the confirmation box');
                    confirmCheckbox.focus();
                    return false;
                }
                
                // Confirm payment
                const paymentMethods = {
                    'bank_transfer': 'Bank Transfer',
                    'cash': 'Cash Payment',
                    'paystack': 'Paystack Payment'
                };
                
                const methodName = paymentMethods[paymentMethod];
                if (!confirm(`Confirm ${methodName} of ₦${amount.toFixed(2)}?`)) {
                    e.preventDefault();
                    return false;
                }
                
                return true;
            });
        }
        
        // Auto-select bank transfer if coming from service request
        {% if request.payment_method == 'bank_transfer' %}
        if (paymentMethodSelect) {
            paymentMethodSelect.value = 'bank_transfer';
            showPaymentMethodFields();
        }
        {% endif %}
        
        // Update steps based on payment method
        paymentMethodSelect.addEventListener('change', function() {
            const steps = document.querySelectorAll('.step');
            if (this.value === 'bank_transfer') {
                steps.forEach(step => step.classList.add('active'));
            } else {
                steps.forEach(step => step.classList.remove('active'));
                steps[0].classList.add('active');
            }
        });
    });
</script>
{% endblock %}